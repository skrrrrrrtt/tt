--!strict
-- Kohana Volcano Teleport + Equip Rod + LegitFishing + **WORKING** Fish Rarity Tracker
local Players          = game:GetService("Players")
local RunService       = game:GetService("RunService")
local ReplicatedStorage= game:GetService("ReplicatedStorage")
local Player           = Players.LocalPlayer
local Character, Humanoid

----------------------------------------------------------------
-- 1. Wait for character + teleport
----------------------------------------------------------------
local function waitForCharacter()
    if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
        Character = Player.Character
        Humanoid  = Character:FindFirstChildOfClass("Humanoid")
        return
    end
    Player.CharacterAdded:Wait()
    Character = Player.Character
    Humanoid  = Character:WaitForChild("Humanoid")
end
waitForCharacter()

local volcanoCFrame = CFrame.new(
    -628.758911, 35.710186, 104.373764,
    0.482912123, 1.81591773e-08, 0.875668824,
    3.01732896e-08, 1, -3.73774007e-08,
    -0.875668824, 4.44718076e-08, 0.482912123
)
Character:WaitForChild("HumanoidRootPart").CFrame = volcanoCFrame
print("Teleported to Kohana Volcano")

----------------------------------------------------------------
-- 2. Equip rod from hotbar (change slot if needed)
----------------------------------------------------------------
task.delay(0.5, function()
    local Net = ReplicatedStorage
        :WaitForChild("Packages")
        :WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0")
        :WaitForChild("net")
    local REEquipToolFromHotbar = Net:WaitForChild("RE/EquipToolFromHotbar")
    pcall(function()
        REEquipToolFromHotbar:FireServer(1)
    end)
    print("Rod equipped from hotbar slot 1")
end)

----------------------------------------------------------------
-- 3. LegitFishing automation
----------------------------------------------------------------
task.spawn(function()
    repeat task.wait() until game:IsLoaded()
    local Net = ReplicatedStorage
        :WaitForChild("Packages")
        :WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0")
        :WaitForChild("net")
    local RfCancel = Net:WaitForChild("RF/CancelFishingInputs")
    local FishingController = require(ReplicatedStorage.Controllers.FishingController)
    local Constants = require(ReplicatedStorage.Shared.Constants)
    Constants.FishingCooldownTime = 0

    local States = {
        Idle = "Idle", Casting = "Casting", Waiting = "Waiting",
        Minigame = "Minigame", Reeling = "Reeling", Completed = "Completed",
    }
    local CurrentState = States.Idle
    local CurrentGuid = nil
    local MinigameCompleted = false
    local StateChangeTime = os.clock()

    local function DetectState()
        local Guid = FishingController:GetCurrentGUID()
        if Guid then
            if CurrentState ~= States.Minigame then
                CurrentGuid = Guid
                MinigameCompleted = false
            end
            return States.Minigame
        end
        if CurrentGuid and not Guid then
            local IsBusy = (FishingController.FishingLine and FishingController.FishingLine.Parent)
                or (FishingController.FishingBobber and FishingController.FishingBobber.Parent)
                or FishingController._isFishing
                or FishingController._isReeling
            if IsBusy then return States.Reeling end
            if MinigameCompleted then return States.Completed end
            CurrentGuid = nil
            return States.Idle
        end
        return (FishingController.OnCooldown and FishingController:OnCooldown() or false)
            and States.Waiting or States.Idle
    end

    while true do
        if not (Character and Character:FindFirstChild("HumanoidRootPart")) then
            task.wait(1); continue
        end
        local NewState = DetectState()
        if NewState ~= CurrentState then
            CurrentState = NewState
            StateChangeTime = os.clock()
        end
        if (CurrentState == States.Casting or CurrentState == States.Waiting)
        and (os.clock() - StateChangeTime) > 8 then
            pcall(RfCancel.InvokeServer, RfCancel)
            CurrentState = States.Idle
            StateChangeTime = os.clock()
        end
        if CurrentState == States.Idle then
            if not FishingController:OnCooldown() then
                pcall(RfCancel.InvokeServer, RfCancel)
                pcall(FishingController.RequestChargeFishingRod, FishingController, nil, true)
                CurrentState = States.Casting
            end
        end
        if CurrentState == States.Minigame then
            local ClickConnection
            ClickConnection = RunService.Heartbeat:Connect(function()
                if not FishingController:GetCurrentGUID() then
                    if ClickConnection then ClickConnection:Disconnect() end
                    return
                end
                for i = 1, 5 do
                    pcall(FishingController.FishingMinigameClick, FishingController)
                end
            end)
            while FishingController:GetCurrentGUID() do task.wait() end
            if ClickConnection then ClickConnection:Disconnect() end
            MinigameCompleted = true
            CurrentState = States.Completed
        end
        if CurrentState == States.Completed then
            CurrentGuid = nil
            MinigameCompleted = false
            CurrentState = States.Idle
        end
        task.wait()
    end
end)
print("LegitFishing loaded – running silently.")

----------------------------------------------------------------
-- 4. FISH RARITY TRACKER UI
----------------------------------------------------------------
local PlayerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
local Gui = Instance.new("ScreenGui")
Gui.Name = "FishRarityTracker"
Gui.ResetOnSpawn = false
Gui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 220, 0, 230)
Frame.Position = UDim2.new(0.02, 0, 0.25, 0)
Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Frame.BorderSizePixel = 0
Frame.BackgroundTransparency = 0.35
Frame.Parent = Gui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBold
Title.Text = "Fish Tracker"
Title.TextSize = 20
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.Parent = Frame

local rarityNames = {
    [1] = "Common",
    [2] = "Uncommon",
    [3] = "Rare",
    [4] = "Epic",
    [5] = "Legendary",
    [6] = "Mythic",
    [7] = "SECRET",
}
local rarityColors = {
    [1] = Color3.fromRGB(180,180,180),
    [2] = Color3.fromRGB(80,255,80),
    [3] = Color3.fromRGB(70,140,255),
    [4] = Color3.fromRGB(170,70,255),
    [5] = Color3.fromRGB(255,170,0),
    [6] = Color3.fromRGB(255,70,70),
    [7] = Color3.fromRGB(255,255,0),
}

local counters = {}
for tier = 1, 7 do
    local label = Instance.new("TextLabel")
    label.Parent = Frame
    label.Size = UDim2.new(1, -10, 0, 25)
    label.Position = UDim2.new(0, 5, 0, 30 + tier*27)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextColor3 = rarityColors[tier]
    label.Text = rarityNames[tier] .. ": 0"
    counters[tier] = {label = label, count = 0}
end

----------------------------------------------------------------
-- 5. **WORKING** FISH CATCH EVENT (scans ReplicatedStorage.Items)
----------------------------------------------------------------
local Net = ReplicatedStorage
    .Packages._Index["sleitnick_net@0.2.0"]
    .net

local FishNotify = Net:WaitForChild("RE/ObtainedNewFishNotification")

-- Build fishId → tier map from ReplicatedStorage.Items
local Items = ReplicatedStorage:WaitForChild("Items")
local fishTierMapping = {}

for _, module in ipairs(Items:GetChildren()) do
    if module:IsA("ModuleScript") then
        local ok, data = pcall(require, module)
        if ok and typeof(data) == "table" and data.Data and data.Data.Type == "Fishes" then
            local id   = data.Data.Id
            local tier = data.Data.Tier or 1
            if id then
                fishTierMapping[id] = tier
            end
        end
    end
end

print(string.format("Mapped %d fish to tiers", table.size(fishTierMapping)))

-- Listen for every caught fish
FishNotify.OnClientEvent:Connect(function(fishId, ...)
    local tier = fishTierMapping[fishId]
        or fishTierMapping[tostring(fishId)]
        or fishTierMapping[tonumber(fishId)]

    if tier and counters[tier] then
        counters[tier].count += 1
        counters[tier].label.Text = rarityNames[tier] .. ": " .. counters[tier].count
        print(string.format("[Fish Tracker] Caught %s (tier %d)", rarityNames[tier], tier))
    else
        warn("[Fish Tracker] Unknown fishId:", fishId)
    end
end)

print("Fish rarity tracker loaded – listening for RE/ObtainedNewFishNotification")
